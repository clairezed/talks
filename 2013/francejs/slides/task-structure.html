<h2 id="Structurer-une-tache-Grunt"><a href="#Structurer-une-tache-Grunt" class="headerlink" title="Structurer une tâche Grunt"></a>Structurer une tâche Grunt</h2><p>@@@</p>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><p>+</p>
<h3 id="Orchestration"><a href="#Orchestration" class="headerlink" title="Orchestration"></a>Orchestration</h3><p>+</p>
<h3 id="Librairie"><a href="#Librairie" class="headerlink" title="Librairie"></a>Librairie</h3><p>+</p>
<h3 id="Documentation"><a href="#Documentation" class="headerlink" title="Documentation"></a>Documentation</h3><p>@@@</p>
<h2 id="Configuration-1"><a href="#Configuration-1" class="headerlink" title="Configuration"></a>Configuration</h2><pre><code class="bash">grunt translateJS:english
</code></pre>
<p>@@@</p>
<h2 id="Orchestration-1"><a href="#Orchestration-1" class="headerlink" title="Orchestration"></a>Orchestration</h2><pre><code class="javascript"><span class="comment">// ./tasks/translate.js</span>
<span class="keyword">var</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);

<span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">grunt</span>)</span>{
  <span class="keyword">var</span> steps = <span class="built_in">require</span>(<span class="string">'./lib/i18n.js'</span>)(grunt);

  <span class="comment">// callable as `grunt translateJS:&lt;lang&gt;`</span>
  grunt.registerTask(<span class="string">'translateJS'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">lang</span>)</span>{
    grunt.config.set(<span class="string">'language'</span>, lang);

    <span class="keyword">async</span>.waterfall([
      steps.downloadSpreadsheet.bind(steps),
      steps.locateLanguage.bind(steps),
      steps.createJSFile.bind(steps)
    ], <span class="keyword">this</span>.async());

  });
};
</code></pre>
<p>@@@</p>
<h2 id="Librairie-1"><a href="#Librairie-1" class="headerlink" title="Librairie"></a>Librairie</h2><pre><code class="javascript"><span class="comment">// ./lib/i18n.js</span>
<span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>);

<span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">i18nTask</span>(<span class="params">grunt</span>)</span>{
    <span class="keyword">return</span> {

    downloadSpreadsheet: <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>{
      <span class="comment">// …</span>
    },

    locateLanguage: <span class="function"><span class="keyword">function</span>(<span class="params">csv, props, done</span>)</span>{
      <span class="comment">// …</span>
    },

    createJSFile: <span class="function"><span class="keyword">function</span>(<span class="params">sheet, props, done</span>)</span>{
      <span class="comment">// …</span>
    }


  };
};
</code></pre>
<p>@@@</p>
<pre><code class="javascript"><span class="comment">// ./lib/i18n.js</span>

<span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">i18nTask</span>(<span class="params">grunt</span>)</span>{
  <span class="keyword">return</span> {

  downloadSpreadsheet: <span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>{
    <span class="keyword">var</span> url = grunt.config.get(<span class="string">'i18nUrl'</span>);

  request.get(url, <span class="function"><span class="keyword">function</span> (<span class="params">error, response, body</span>) </span>{
    <span class="keyword">if</span> (error) <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">'Request error'</span>);
    <span class="keyword">if</span> (response.statusCode !== <span class="number">200</span>) <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">'Could not find  translation spreadsheet'</span>);
    <span class="keyword">if</span> (!body) <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">'Spreadsheet body is empty'</span>);

    <span class="keyword">var</span> csv = util.CSVToArray(body);
    <span class="keyword">var</span> props = spreadsheet[<span class="number">0</span>].slice(<span class="number">2</span>);
    done(<span class="literal">null</span>, csv, props);
  });

  }
};
</code></pre>
<p>@@@</p>
<h2 id="Tester"><a href="#Tester" class="headerlink" title="Tester"></a>Tester</h2><pre><code class="javascript"><span class="comment">// ./test/unit/lib/i18n.js</span>

describe(<span class="string">'i18nTask.downloadSpreadsheet'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
  it(<span class="string">'should parse properly a remote document'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="comment">// …</span>
  });

  it(<span class="string">'should raise an error on unexpected spreadsheet format'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="comment">// …</span>
  });

  it(<span class="string">'should fail if remote document is unavailable'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="comment">// …</span>
  });
});
</code></pre>
<p>@@@</p>
<h2 id="Stubber"><a href="#Stubber" class="headerlink" title="Stubber"></a>Stubber</h2><p>Simuler des erreurs I/O.</p>
<p>Isoler les appels I/O.</p>
<p>Fonctionner localement, sans infrastructure externe.</p>
<p>@@@</p>
<pre><code class="javascript"><span class="keyword">var</span> sinon = request(<span class="string">'sinon'</span>);
<span class="keyword">var</span> gruntStub = sinon.stub(grunt.file, <span class="string">'write'</span>);

expect(
  gruntStub.calledWith(
    <span class="string">'dummy config valueen-GB.js'</span>,
    <span class="string">'define('</span>+dummyOutput+<span class="string">');'</span>
  )
).to.be.ok;
</code></pre>
<p>@@@</p>
<pre><code class="javascript"><span class="comment">// ./test/unit/lib/i18n.js</span>

<span class="keyword">var</span> requestStub = sinon.stub(request, <span class="string">'get'</span>);

it(<span class="string">'should parse properly a remote document'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
  requestStub.yields(<span class="literal">null</span>, {<span class="attr">statusCode</span>: <span class="number">200</span>}, validCSVContent);
});

it(<span class="string">'should raise an error on unexpected spreadsheet format'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
  requestStub.yields(<span class="literal">null</span>, {<span class="attr">statusCode</span>: <span class="number">200</span>}, <span class="string">'I am not CSV'</span>);
});

it(<span class="string">'should fail if remote document is unavailable'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
  requestStub.yields(<span class="literal">null</span>, {<span class="attr">statusCode</span>: <span class="number">500</span>});
});
</code></pre>
